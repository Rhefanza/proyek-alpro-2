<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze - EconoVision</title>

    <!-- Google Fonts (from HTML2) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Raleway:wght@300;400;700&family=Ubuntu:wght@300;400;700&display=swap"
        rel="stylesheet">

    <!-- Vendor CSS Files (from HTML2) -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS -->
    <link href="assets/css/main.css" rel="stylesheet">

    <style>
        /* Additional style for 4-step wizard layout, blended with main.css */
        .step-section {
            padding: 80px 0;
        }

        .step-box {
            background: var(--surface-color);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.05);
        }

        .x-list label {
            display: block;
            margin-bottom: 6px;
        }

        .hidden {
            display: none !important;
        }

        .hero-upload-btn {
            background: var(--accent-color);
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }

        #statRes {
            white-space: pre-wrap;
            background: var(--surface-color);
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid var(--accent-color);
        }
    </style>
</head>

<body class="index-page">

    <!-- ============ NAVBAR (from HTML2) ============ -->
    <header id="header" class="header d-flex align-items-center sticky-top">
        <div class="container-fluid container-xl d-flex justify-content-between align-items-center">

            <a href="/" class="logo d-flex align-items-center">
                <h1 class="sitename">EconoVision</h1>
            </a>

            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="/howto">How It Works</a></li>
                    <li><a href="/app" class="btn-getstarted">Analyze Data</a></li>
                    <li><a href="/convert" class="btn-getstarted">Convert IMG</a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>

        </div>
    </header>
    <!-- END NAV -->

    <!-- ============ STEP 1: UPLOAD ============ -->
    <section id="step1" class="hero section light-background">
        <div class="container">
            <div class="row align-items-center gy-4">
                <div class="col-lg-6" data-aos="fade-right">
                    <h1 class="fw-bold">Upload Your Dataset</h1>
                    <p>Start by importing your CSV or Excel file to begin the analysis.</p>

                    <input type="file" id="fileInput" hidden onchange="uploadFile()">
                    <button class="hero-upload-btn mt-3" onclick="document.getElementById('fileInput').click()">
                        Import Your Data
                    </button>
                </div>

                <div class="col-lg-6 text-center" data-aos="fade-left">
                    <img src="{{ url_for('static', filename='images/uploads.jpeg') }}" class="img-fluid rounded-4"
                        alt="Upload">
                </div>
            </div>
        </div>
    </section>

    <!-- ============ STEP 2: DATA TYPE ============ -->
    <section id="step2" class="section hidden">
        <div class="container text-center">

            <h2 class="fw-bold">Choose Your Data Type</h2>

            <div class="row gy-4 mt-4">

                <div class="col-lg-4" data-aos="zoom-in">
                    <div class="service-item position-relative p-4" onclick="setType('cross_section')"
                        style="cursor:pointer;">
                        <h4>Cross-Section üîò</h4>
                        <p>Single point in time.</p>
                    </div>
                </div>

                <div class="col-lg-4" data-aos="zoom-in" data-aos-delay="150">
                    <div class="service-item position-relative p-4" onclick="setType('time_series')"
                        style="cursor:pointer;">
                        <h4>Time-Series ‚è±Ô∏è</h4>
                        <p>Repeated observations over time.</p>
                    </div>
                </div>

                <div class="col-lg-4" data-aos="zoom-in" data-aos-delay="300">
                    <div class="service-item position-relative p-4" onclick="setType('panel')" style="cursor:pointer;">
                        <h4>Panel Data üìÜ</h4>
                        <p>Combination of cross-section and time-series.</p>
                    </div>
                </div>

            </div>

        </div>
    </section>

    <!-- ============ STEP 3: VARIABLES ============ -->
    <section id="step3" class="section hidden">
        <div class="container">

            <h2 class="fw-bold text-center">Choose Your Variables</h2>

            <div class="row justify-content-center mt-4">

                <div class="col-lg-6">

                    <label class="fw-bold">Target Variable (Y)</label>
                    <select id="yVar" class="form-control mb-3"></select>

                    <label class="fw-bold">Predictor Variables (X)</label>
                    <div class="p-3 border rounded mb-3 x-list" style="max-height: 200px; overflow-y:auto;">
                        <div id="xVars"></div>
                    </div>

                    <div id="panelInputs" class="hidden">
                        <label class="fw-bold">Entity Column</label>
                        <select id="entityCol" class="form-control mb-3"></select>

                        <label class="fw-bold">Time Column</label>
                        <select id="timeCol" class="form-control mb-4"></select>
                    </div>

                    <button class="btn-getstarted w-100" onclick="runAnalyze()">Run Analysis</button>
                </div>

            </div>
        </div>
    </section>

    <!-- ============ STEP 4: RESULT ============ -->
    <section id="step4" class="section hidden">
        <div class="container">

            <h2 class="fw-bold text-center mb-4">Data Report</h2>

            <div class="result-card mb-4">
                <h4>Statistical Analysis</h4>
                <pre id="statRes"></pre>
            </div>

            <div class="result-card mb-4">
                <h4>Insights</h4>
                <p id="insightRes"></p>
            </div>

            <div class="text-center">
                <a id="pdfBtn" class="btn-getstarted">Export to PDF</a>
            </div>

        </div>
    </section>

    <!-- ============ JS (UNCHANGED) ============ -->
    <script>
        /* ENTIRE JS FROM YOUR HTML3 ‚Äî Kept EXACTLY the same */
        window.onload = async function () {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('dataset_id');
            if (id) {
                document.getElementById('datasetId').value = id;
                const res = await fetch(`/api/datasets/${id}`);
                const data = await res.json();
                fillInputs(data.columns);
                toStep('step2');
            }
        }

        function toStep(id) {
            ['step1', 'step2', 'step3', 'step4'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            const fd = new FormData(); fd.append('file', file);

            const res = await fetch('/datasets', { method: 'POST', body: fd });
            const data = await res.json();

            document.getElementById('datasetId').value = data.dataset_id;
            fillInputs(data.columns);
            toStep('step2');
        }

        function setType(type) {
            document.getElementById('dataType').value = type;
            if (type === 'panel') document.getElementById('panelInputs').classList.remove('hidden');
            else document.getElementById('panelInputs').classList.add('hidden');
            toStep('step3');
        }

        function fillInputs(cols) {
            const y = document.getElementById('yVar');
            const ent = document.getElementById('entityCol');
            const time = document.getElementById('timeCol');
            const x = document.getElementById('xVars');

            y.innerHTML = ent.innerHTML = time.innerHTML = '<option>--Select--</option>';
            x.innerHTML = '';

            cols.forEach(c => {
                const opt = `<option value="${c}">${c}</option>`;
                y.innerHTML += opt; ent.innerHTML += opt; time.innerHTML += opt;
                x.innerHTML += `<label><input type="checkbox" value="${c}"> ${c}</label>`;
            });
        }

        async function runAnalyze() {
            const x = Array.from(document.querySelectorAll('#xVars input:checked')).map(i => i.value);
            const payload = {
                dataset_id: document.getElementById('datasetId').value,
                data_type: document.getElementById('dataType').value,
                y_var: document.getElementById('yVar').value,
                x_vars: x,
                entity_col: document.getElementById('entityCol').value,
                time_col: document.getElementById('timeCol').value
            };

            const res = await fetch('/analyses',
                { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

            const d = await res.json();

            const poll = setInterval(async () => {
                const r = await fetch(`/analyses/${d.analysis_id}`);
                const final = await r.json();
                if (final.status === 'completed') {
                    clearInterval(poll);
                    renderResult(final.results, final.interpretation, d.analysis_id);
                }
            }, 2000);

            alert("Analyzing...");
        }

        function renderResult(res, insight, id) {
            toStep('step4');
            let table = res.final_model_estimation?.summary_table ||
                res.model_estimation?.summary_table || "No Table";
            document.getElementById('statRes').innerText = table;
            document.getElementById('insightRes').innerText = insight || "No insight generated.";
            document.getElementById('pdfBtn').href = `/api/download-pdf/${id}`;
        }
    </script>

    <!-- ============ FOOTER (from HTML2) ============ -->
    <footer id="footer" class="footer">
        <div class="container footer-top">
            <div class="row gy-4">

                <div class="col-lg-4 col-md-6 footer-about">
                    <a href="/" class="logo d-flex align-items-center">
                        <span class="sitename">EconoVision</span>
                    </a>
                    <p>
                        <strong>Financial Clarity You Can Trust</strong><br>
                        Trusted financial guidance since 1987.
                    </p>
                </div>

                <div class="col-lg-4 col-md-6 footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/howto">How It Works</a></li>
                        <li><a href="/app">Analyze Data</a></li>
                        <li><a href="/convert">Convert IMG</a></li>
                    </ul>
                </div>

                <div class="col-lg-4 col-md-6 text-lg-end">
                    <p>¬© 2025 All Rights Reserved</p>
                </div>

            </div>
        </div>
    </footer>

    <!-- Vendor JS -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script> AOS.init(); </script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

    <!-- Main JS -->
    <script src="assets/js/main.js"></script>

</body>

</html>